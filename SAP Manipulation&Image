from datetime import datetime
import time
import win32com.client
import os
import pyautogui
from openpyxl import load_workbook,Workbook
def get_session():
    try:
        # Abrir instancia en SAP
        SapGuiAuto = win32com.client.GetObject("SAPGUI")
        app = SapGuiAuto.GetScriptingEngine
        connection = app.Children(0)
        session = connection.Children(0)
        return session
    except Exception as e:
        print("Error GET_SESSION:", str(e))

def enter_tx(tx):
    global session
    try:
        session.findById("wnd[0]/tbar[0]/okcd").text = f"/n{tx}"
        session.findById("wnd[0]").sendVKey(0)
    except Exception as e:
        print("Error ENTER_TX:", str(e))

# Cargar archivo de asientos
archivo = r"C:\Users\Ext_rgutierrezc\OneDrive - Grupo Alicorp\Escritorio\Siglo BPO (1)\Base2.xlsx"
wb = load_workbook(archivo)
ws=wb['DATA']
sociedad="PE18"

# Definir la ruta de la carpeta donde se guardarán las capturas de pantalla
base_path = r"C:\Users\Ext_rgutierrezc\OneDrive - Grupo Alicorp\Escritorio\Siglo BPO (1)"
ss_folder = os.path.join(base_path, "SCREENSHOTS")

# Crear la carpeta "SS" si no existe
if not os.path.exists(ss_folder):
    os.makedirs(ss_folder)	

session = get_session()

for i, fila in enumerate(ws.iter_rows(min_row=2, max_row=ws.max_row, values_only=True), start=2):
    # Solo filas con datos
    nro_documento = fila[0]
    sociedad="PE18"
    if not nro_documento:
        continue

    try:
        ejercicio = 2022
        # Ir a la TX 
        enter_tx("FB03")
        session.findById("wnd[0]").maximize()

        # Nro Documento
        session.findById("wnd[0]/usr/txtRF05L-BELNR").text = nro_documento
        # Sociedad
        session.findById("wnd[0]/usr/ctxtRF05L-BUKRS").text = sociedad
        # Ejercicio
        session.findById("wnd[0]/usr/txtRF05L-GJAHR").text = ejercicio
        # Ejecutar
        session.findById("wnd[0]").sendVKey(0)

        ### SOMBRERITO

        session.findById("wnd[0]/tbar[1]/btn[5]").press()
        session.findById("wnd[1]/usr/txtBKPF-AWKEY").setFocus()
        session.findById("wnd[1]/usr/txtBKPF-AWKEY").caretPosition = 14
        session.findById("wnd[1]").sendVKey(2)

        # SELECCIONAR CANTIDADES
        session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMDETAIL:SAPLMIGO:0301/subSUB_DETAIL:SAPLMIGO:0300/tabsTS_GOITEM/tabpOK_GOITEM_QUANTITIES").select()

        # Intentamos seleccionar los ítems manualmente uno por uno
        try:
            # Ítem 0
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM").columns.elementAt(2).selected = True
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM").reorderTable("0 45 1 46 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77")
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM").columns.elementAt(2).width = 38
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM").columns.elementAt(1).width = 11
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,0]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,0]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
             # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-0.png"))
                        # Ítem 1

            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,1]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,1]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
             # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-1.png"))
                    # Ítem 2
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,2]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,2]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
             # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-2.png"))
                        # Ítem 3
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,3]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,3]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
                # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-3.png"))
                        # Ítem 4
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM").verticalScrollbar.position = 4
            time.sleep(3)
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,0]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,0]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-4.png"))
                        # Ítem 5

            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,1]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,1]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
             # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-5.png"))
            # Ítem 6
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,2]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,2]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
             # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-6.png"))
                        # Ítem 7
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,3]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,3]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
             # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-7.png"))
                    # Ítem 2
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM").verticalScrollbar.position = 8
            time.sleep(3)
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,0]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,0]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
              # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-8.png"))
                        # Ítem 3
  
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,1]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,1]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
                # Convertir la captura de pantalla a un objeto Pillow para poder modificarla
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-9.png"))
                        # Ítem 4
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,2]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,2]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
                      
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-10.png"))
                        # Ítem 5
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,3]").setFocus()
            session.findById("wnd[0]/usr/ssubSUB_MAIN_CARRIER:SAPLMIGO:0003/subSUB_ITEMLIST:SAPLMIGO:0200/tblSAPLMIGOTV_GOITEM/btnGOITEM-ZEILE[0,3]").press()
            time.sleep(1)
            screenshot = pyautogui.screenshot()
            
        # Redimensionar la captura (por ejemplo, a 800x600 píxeles)
            screenshot.save(os.path.join(ss_folder, f"{nro_documento}-11.png"))

        except Exception as e:
            print(f"Error o fin de ítems en el ítem 0 del documento {nro_documento}: {str(e)}")


    except Exception as e:
        # En caso de error, almacenar el error en la columna final
        ws.cell(row=i, column=ws.max_column).value = f"Error: {str(e)}"

# Finalmente, guardar el archivo Excel con los cambios
wb.save("ruta_al_archivo.xlsx")
